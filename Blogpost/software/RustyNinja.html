<!DOCTYPE html>

<html lang="en">

        <head>
                <!-- Page information -->
                <meta charset="UTF-8" />
                <meta name="node_id" content="rustyninja">
                <meta name="viewport" content="width=device-width, initial-scale=1.0" />
                <link rel="shortcut icon" href="/favicon.ico" />

                <!-- Set title -->
                <title>resec.dk</title>

                <!-- Includes -->
                <script src="/obs.html/static/obsidian_core.js"></script>
<script src="/obs.html/static/encoding.js"></script>
<link rel="stylesheet" href="/obs.html/static/master.css" />
<script src="https://unpkg.com/smiles-drawer@2.0.3/dist/smiles-drawer.min.js"></script><script src="/obs.html/static/smiles.js"></script>
<script type="module">
    import mermaid from 'https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.esm.min.mjs';
    mermaid.initialize({
            'securityLevel': 'loose',
            'theme': 'dark',
            'themeVariables': {
                    'darkMode': true,
            }
    });
</script>
<script>
  MathJax = {
    loader: {
      load: [
        '[tex]/action',
        'output/chtml',
        '[tex]/centernot'
      ]
    },
    tex: {
      inlineMath: [ ["\\(","\\)"] ],
      displayMath: [ ["\\[","\\]"] ],
      processEscapes: true,
      processEnvironments: true,
      packages: {'[+]': ['centernot']}
    }
  };
</script>
<script type="text/javascript" id="MathJax-script" async
  src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js">
</script>
<script src="/obs.html/static/dirtree.js"></script>
<link rel="stylesheet" href="/custom.css" />



                <!-- Onload tweaks -->
                <script>
                        const CURRENT_NODE = 'rustyninja';
                        const PAGE_DEPTH = 2;
                </script>
        </head>

<body class="theme-obs-light">
        <div id="antiflash" style="display: none;"></div>
        <script>
                document.getElementById('antiflash').style.display = 'block';
        </script>
        
        <div id="page_holder" class="flex_col">
                <div id="header" class="header" style="position:fixed">
                        <div id="header_flex" class="flex_row">
                                <a href="/index.html" id="homelink" title="Clear screen and go to homepage">resec.dk</a>
                                <div class="navbar-button" onclick="toggle_menu()">
                                        ≡
                                </div>
                                <div id="navbar" class="navbar">
                                        
                                        <a href="/">resec.dk</a>
                                        <div class="icon-tray">
                                                
                                                
                                                
                                        
                                                
                                                
                                        </div>
                                </div>
                        </div>
                        
                </div>
                <div id="header2" class="header">
                        <div id="header_flex2" class="flex_row">
                                <a href="/index.html" id="homelink" title="Clear screen and go to homepage">/resec.dk</a>
                                <div class="navbar-button" onclick="toggle_menu()">
                                        ≡
                                </div>
                                <div id="navbar2" class="navbar">
                                        
                                        <div class="icon-tray">
                                                
                                                
                                                
                                                        <div >
            <a id="dirtree_link" class="system-link" href="/obs.html/dir_index.html" title="View directory tree">
                    <img src = "/obs.html/static/dirtree.svg" style="width: 12px; padding: 4px;" alt="Directory tree link"/>
            </a>
        </div>
                                                
                                                
                                        </div>
                                </div>
                        </div>
                        
                </div>
                <div class="flex_row" id="container_row">
                        <div class="container-wrapper ">
                                <div class="container">
                                <div class="content"><h1 id="rustyninja-a-stealthy-file-exfiltrader-tool">RustyNinja - A stealthy file exfiltrader tool</h1>
<div class="callout callout-warning active" rasa="1">
<div class="callout-title ">
<div class="callout-title-icon"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="callout-icon"><path d="M10.29 3.86L1.82 18a2 2 0 001.71 3h16.94a2 2 0 001.71-3L13.71 3.86a2 2 0 00-3.42 0z"></path><line x1="12" y1="9" x2="12" y2="13"></line><line x1="12" y1="17" x2="12.01" y2="17"></line></svg>
</div>
<div class="callout-title-name">Warning
</div>
</div>
<div class="callout-content">
<p>Beware this is really really shitty and ugly code that by some miracle works. Basically a learn-rust-project for me.</p>
</div>
</div>
<p>A (in spirit) rust version of <a href="[https://github.com/PowerShellMafia/PowerSploit/blob/master/Exfiltration/Invoke-NinjaCopy.ps1](https://github.com/PowerShellMafia/PowerSploit/blob/master/Exfiltration/Invoke-NinjaCopy.ps1)" class="external-link">NinjaCopy</a>.   </p>
<p>Find the sourcecode and compiled executables here: <a href="https://github.com/kusk/RustyNinja" class="external-link">GitHub - kusk/RustyNinja: A Rust version of Invoke-Ninjacopy</a>   </p>
<p>This tool lets you, if you have obtained <strong>Admin privileges</strong>, access and copy otherwise locked files like registry database files(SYSTEM, SAM, SECURITY) or NTDS.dit. This is done by opening a read handle to the entire NTFS volume and then by parsing the structure independently.   </p>
<div class="callout callout-tip active" rasa="1">
<div class="callout-title ">
<div class="callout-title-icon"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="callout-icon"><path d="M8.5 14.5A2.5 2.5 0 0011 12c0-1.38-.5-2-1-3-1.072-2.143-.224-4.054 2-6 .5 2.5 2 4.9 4 6.5 2 1.6 3 3.5 3 5.5a7 7 0 11-14 0c0-1.153.433-2.294 1-3a2.5 2.5 0 002.5 2.5z"></path></svg>
</div>
<div class="callout-title-name">Tip
</div>
</div>
<div class="callout-content">
<p>Accessing registry databases and NTDS.dit this way may(might/hopefully/test it goddamn it!) bypass EDR/detection which would be lovely during red team assignments. Other methods such as using ntdsutil, disk shadow, reg save or via RPC can be way too <strong>noisy</strong>.</p>
</div>
</div>
<div class="callout callout-warning active" rasa="1">
<div class="callout-title ">
<div class="callout-title-icon"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="callout-icon"><path d="M10.29 3.86L1.82 18a2 2 0 001.71 3h16.94a2 2 0 001.71-3L13.71 3.86a2 2 0 00-3.42 0z"></path><line x1="12" y1="9" x2="12" y2="13"></line><line x1="12" y1="17" x2="12.01" y2="17"></line></svg>
</div>
<div class="callout-title-name">Warning
</div>
</div>
<div class="callout-content">
<p>Currently this gets detected by CrowdStrike EDR and partially(SAM/SYSTEM/SECURITY DB) by Cortex EDR.</p>
</div>
</div>
<p>I have added an additional detection bypass which XOR's the file content in memory before writing it to desk. The output filename has a randomly generated filename just in case.   </p>
<p>If you don't want to XOR the file content for some reason, just give it 0x00 as the XOR byte.   </p>
<p>The program takes two arguments.   </p>
<p>Using RustyNinja:   </p>
<div class="lang-rust">

<div class="codehilite"><pre><span></span><code><span class="n">rustyninja</span><span class="p">.</span><span class="n">exe</span><span class="w"> </span><span class="p">[</span><span class="n">path</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">file</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">copy</span><span class="p">]</span><span class="w"> </span><span class="p">[</span><span class="n">hex</span><span class="w"> </span><span class="n">value</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">Xor</span><span class="w"> </span><span class="n">data</span><span class="w"> </span><span class="n">with</span><span class="p">]</span>

<span class="n">Example</span>: 

<span class="nc">C</span>:<span class="err">\</span><span class="n">Users</span><span class="err">\</span><span class="n">a</span><span class="err">\</span><span class="n">rustyninja</span><span class="p">.</span><span class="n">exe</span><span class="w"> </span><span class="n">c</span>:<span class="err">\</span><span class="n">windows</span><span class="err">\</span><span class="n">system32</span><span class="err">\</span><span class="n">config</span><span class="err">\</span><span class="n">SYSTEM</span><span class="w"> </span><span class="mh">0x33</span>

<span class="n">Xoring</span><span class="w"> </span><span class="n">and</span><span class="w"> </span><span class="n">saving</span><span class="w"> </span><span class="mi">20185088</span><span class="w"> </span><span class="n">bytes</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="n">data</span><span class="w"> </span><span class="n">to</span>: <span class="nc">tySXLjFMRndoxTuq</span>
</code></pre></div>


</div>

<p>Compiling:   </p>
<div class="lang-rust">

<div class="codehilite"><pre><span></span><code><span class="n">cargo</span><span class="w"> </span><span class="n">build</span><span class="w"> </span><span class="o">--</span><span class="n">release</span>
</code></pre></div>


</div>

<p>Big thanks and inspiration from Colin Finck who created the NTFS implementation in Rust.</p></div>
<div class="note-footer">
<div class="tags">

</div>

</div>

                                <!-- end content -->
                                </div>
                        </div>
                </div>
        </div>

        <script src="/obs.html/static/obsidian_tabs_footer.js" type="text/javascript"></script>

        

</body>
</html>
