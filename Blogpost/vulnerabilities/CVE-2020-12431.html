<!DOCTYPE html>

<html lang="en">

        <head>
                <!-- Page information -->
                <meta charset="UTF-8" />
                <meta name="node_id" content="cve-2020-12431">
                <meta name="viewport" content="width=device-width, initial-scale=1.0" />
                <link rel="shortcut icon" href="/favicon.ico" />

                <!-- Set title -->
                <title>resec.dk</title>

                <!-- Includes -->
                <script src="/obs.html/static/obsidian_core.js"></script>
<script src="/obs.html/static/encoding.js"></script>
<link rel="stylesheet" href="/obs.html/static/master.css" />
<script src="https://unpkg.com/smiles-drawer@2.0.3/dist/smiles-drawer.min.js"></script><script src="/obs.html/static/smiles.js"></script>
<script type="module">
    import mermaid from 'https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.esm.min.mjs';
    mermaid.initialize({
            'securityLevel': 'loose',
            'theme': 'dark',
            'themeVariables': {
                    'darkMode': true,
            }
    });
</script>
<script>
  MathJax = {
    loader: {
      load: [
        '[tex]/action',
        'output/chtml',
        '[tex]/centernot'
      ]
    },
    tex: {
      inlineMath: [ ["\\(","\\)"] ],
      displayMath: [ ["\\[","\\]"] ],
      processEscapes: true,
      processEnvironments: true,
      packages: {'[+]': ['centernot']}
    }
  };
</script>
<script type="text/javascript" id="MathJax-script" async
  src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js">
</script>
<script src="/obs.html/static/dirtree.js"></script>
<link rel="stylesheet" href="/custom.css" />



                <!-- Onload tweaks -->
                <script>
                        const CURRENT_NODE = 'cve-2020-12431';
                        const PAGE_DEPTH = 2;
                </script>
        </head>

<body class="theme-obs-light">
        <div id="antiflash" style="display: none;"></div>
        <script>
                document.getElementById('antiflash').style.display = 'block';
        </script>
        
        <div id="page_holder" class="flex_col">
                <div id="header" class="header" style="position:fixed">
                        <div id="header_flex" class="flex_row">
                                <a href="/index.html" id="homelink" title="Clear screen and go to homepage">resec.dk</a>
                                <div class="navbar-button" onclick="toggle_menu()">
                                        ≡
                                </div>
                                <div id="navbar" class="navbar">
                                        
                                        <a href="/">resec.dk</a>
                                        <div class="icon-tray">
                                                
                                                
                                                
                                        
                                                
                                                
                                        </div>
                                </div>
                        </div>
                        
                </div>
                <div id="header2" class="header">
                        <div id="header_flex2" class="flex_row">
                                <a href="/index.html" id="homelink" title="Clear screen and go to homepage">/resec.dk</a>
                                <div class="navbar-button" onclick="toggle_menu()">
                                        ≡
                                </div>
                                <div id="navbar2" class="navbar">
                                        
                                        <div class="icon-tray">
                                                
                                                
                                                
                                                        <div >
            <a id="dirtree_link" class="system-link" href="/obs.html/dir_index.html" title="View directory tree">
                    <img src = "/obs.html/static/dirtree.svg" style="width: 12px; padding: 4px;" alt="Directory tree link"/>
            </a>
        </div>
                                                
                                                
                                        </div>
                                </div>
                        </div>
                        
                </div>
                <div class="flex_row" id="container_row">
                        <div class="container-wrapper ">
                                <div class="container">
                                <div class="content"><h1 id="splastop-streamer-privilege-escalation">Splastop Streamer - Privilege Escalation</h1>
<p>Also published here: <a href="https://blog.improsec.com/tech-blog/privilege-escalation-vulnerability-in-splashtop-streamer" class="external-link">Splashtop Streamer Vulnerability — Improsec | improving security</a>   </p>
<p>This blog post highlights bugs found in installed software while doing vulnerability research. The process for this publication is aligned with the Improsec Responsible Disclosure Policy.   </p>
<h2 id="cve-registered">CVE registered</h2>
<ul>
<li>CVE: <a href="https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2020-12431" class="external-link">CVE-2020-12431</a>   </li>
</ul>
<h2 id="what-is-splashtop-streamer">What is Splashtop Streamer</h2>
<p>Splashtop Streamer is a remote desktop application that allows users to share their desktop and remotely control workstations. The affected component is the Splashtop Updater that is bundled with Splashtop Streamer, as well as certain other Splashtop products.   </p>
<h2 id="timeline">Timeline</h2>
<ul>
<li>13/2-2020 – Improsec identified the vulnerability.   </li>
<li>21/2-2020 – Contact to Splashtop reached, a vulnerability disclosed to the software vendor.   </li>
<li>24/2-2020 – The software vendor acknowledged the vulnerability report.   </li>
<li>13/3-2020 – Software vendor releases an internal software update for testing.   </li>
<li>19/3-2020 – Improsec reviewed the update and acknowledge that the vulnerability was fixed.   </li>
<li>6/4-2020 – Improsec contacts vendor again about another vulnerability in the same update function.   </li>
<li>7/4-2020 – The software vendor acknowledged the vulnerability report.   </li>
<li>14/4-2020 – Software vendor releases an internal software update for testing.   </li>
<li>15/4-2020 – Improsec reviewed the update and acknowledge that the vulnerability was fixed.   </li>
<li>25/4-2020 – Software vendor releases patched software packages.   </li>
<li>19/5-2020 – Public disclosure of the vulnerability.   </li>
</ul>
<p>We want to thank Splashtop Inc. for an effective and professional response.   </p>
<h2 id="walkthrough">Walkthrough</h2>
<p>Using SysInternals AccessEnum showed that all members of the group "Users" had read and write access to "C:\ProgramData\Splashtop". <br />
<img alt="" src="/Blogpost/vulnerabilities/Attachments/3cfeb87aa44e3dcb7310154d66dde52d_MD5.png" />   </p>
<p>Various Splashtop products come bundled with a "Splashtop Updater" package. This package deploys various files, amongst these an executable(sits in taskbar tray) and another executable, "SSUService.exe" that runs as a service in the context of "NT Authority/System".   </p>
<p>Performing a manual update from the tray-application would call “SRUpdate.exe” that would call “SSUService.exe” through a named pipe and start an update process. <br />
<img alt="" src="/Blogpost/vulnerabilities/Attachments/354b42e769b0b5bf5e54a897b3a88187_MD5.png" />   </p>
<p>Monitoring the update process with ProcMon showed, that the service executable read an INI-file from "C:\ProgramData\Splashtop\Splashtop Software Updater\Tracking\". <br />
<img alt="" src="/Blogpost/vulnerabilities/Attachments/a053ffd5508bdaba5e55c618368694bb_MD5.png" />   </p>
<p>Loading the service executable into Ghidra and searching for functions that load INI-files showed the below function(here manually renamed to "parse_ini"). The function showed the different possible variables that could be set in the INI-file, amongst these "Platform" which would be set as a filename used to name a logfile. <br />
<img alt="" src="/Blogpost/vulnerabilities/Attachments/0f449fd2999c9556b8a402a8cd621276_MD5.png" />   </p>
<p>To test the function I created an INI-file with the "Platform" variable set. <br />
<img alt="" src="/Blogpost/vulnerabilities/Attachments/798999344973db145dd2364b4fe2a57d_MD5.png" />   </p>
<p>Calling the update function showed that a CSV-file would be created if not already existing. The file would be created in the same directory as the INI-file and would have “Platform_” appended to the beginning of the defined filename. <br />
<img alt="" src="/Blogpost/vulnerabilities/Attachments/1af0d30036dcf6c4001c9236db4e7d1f_MD5.png" />   </p>
<p>After the CSV-file had been created, “SetSecurityFile” was called to set read and write rights to “Anyone” for the file. <br />
<img alt="" src="/Blogpost/vulnerabilities/Attachments/63b675cb770b0812230808df8dacb013_MD5.png" />   </p>
<p>Setting the "Platform"-variable with a path traversing filename showed, that it was possible to write the CSV-file to any place on the file system. This would also bypass the added “Platform_” to the filename. <br />
<img alt="" src="/Blogpost/vulnerabilities/Attachments/93ee3bb56338beeb3a15c76f358272aa_MD5.png" />   </p>
<p><img alt="" src="/Blogpost/vulnerabilities/Attachments/8a530dd89da68524c4c33970457d3058_MD5.png" />   </p>
<p><img alt="" src="/Blogpost/vulnerabilities/Attachments/0f8fa02bdd59cec184f7b77b4f94bb86_MD5.png" />   </p>
<p>While running the update function the "SRUpdate.exe" executable, which ran in the context of "NT Authority/System", would try to load several non-existing DLL-files from the directory "C:\Program Files(x86)\Splasthop\Splashtop Remote\Server\". Amongst these were the DLL-file called "SRUpdateENU.dll". <br />
<img alt="" src="/Blogpost/vulnerabilities/Attachments/5f27efacf9edb61d78fc2da868a0412a_MD5.png" />   </p>
<p>Since the "SSUService.exe" service, when creating new logfiles, would append a ".csv" to the defined "Platform"-variable and since parent directory rights prevented me from just renaming my CSV-file into f.x. "SRUpdateENU.dll", I had to find a way to prevent the application from appending ".csv" to the filename.   </p>
<p>To do this I used the Alternative Data Streams(ADS) function in NTFS. When defining a filename parted with a colon, the last part will be used for the alternative Data Streams. By setting the "Platform"-variable to f.x. "TEST:" the “CreateFile”-function would automatically append ".csv" as an ADS and TEST would be the full filename.   </p>
<p>Using this technique allowed me to write an empty file to "C:\Program Files(x86)\Splasthop\Splashtop Remote\Server\SRUpdateENU.dll". Every user on the system would be able to write new data to the file. <br />
<img alt="" src="/Blogpost/vulnerabilities/Attachments/d2371fbfdd557b52a49286b9aec5bbb9_MD5.png" />   </p>
<p><img alt="" src="/Blogpost/vulnerabilities/Attachments/8a8b54eb4b343be39a72fe193e2a5741_MD5.png" />   </p>
<p>Compiling a malicious DLL-file which would execute a reverse shell. <br />
<img alt="" src="/Blogpost/vulnerabilities/Attachments/6cbdbfbc8f3f8a3ff30a24cdad99333a_MD5.png" />   </p>
<p>Using "type" to write the content of my malicious DLL-file into the empty "SRUpdateENU.dll", and thereafter calling the update function. <br />
<img alt="" src="/Blogpost/vulnerabilities/Attachments/1d0b00c022c2d36713b720044c9f5fdd_MD5.png" />   </p>
<p>This would execute my reverse shell as "NT Authority/System" and a privilege escalation would be achieved. <br />
<img alt="" src="/Blogpost/vulnerabilities/Attachments/938c34fb785b60683db8e8a4f1a50766_MD5.png" />   </p>
<p><img alt="" src="/Blogpost/vulnerabilities/Attachments/8ec9faf305acd3adf1cc64c47cb750e2_MD5.png" />   </p>
<p>Splashtop Software Updater 1.5.6.16 was released which fixes this problem.   </p>
<h2 id="further-research-into-another-privilege-escalation-vulnerability">Further research into another privilege escalation vulnerability</h2>
<p>I did some further research into the Splashtop Update mechanism after the above vulnerability had been patched. I found that the two programs “SRUpdate.exe” and “SSUServer.exe”, were communicating via the already mentioned named pipe called “SSU_IPC_NAMED_PIPE_0” created by “SSUServer.exe”. When an update call was executed “SRUpdate.exe” would connect to the named pipe and send a 560 bytes long payload. This payload contains the filename of the file that “SSUServer.exe” creates in “C:\ProgramData\Splashtop\Splashtop Software Updater\Tracking\”. The filename is appended the file extension “.ini” by “SSUServer.exe”.   </p>
<p>Wiretapping the named pipe with ioNinja showed the payload sent upon an update call from “SRUpdate.exe” to “SSUServer.exe”. <br />
<img alt="" src="/Blogpost/vulnerabilities/Attachments/77c915bcdbbcc62d398fcab0b603266b_MD5.png" />   </p>
<p>Checking permissions on the named pipe showed that all users were allowed to read/write to the pipe. <br />
<img alt="" src="/Blogpost/vulnerabilities/Attachments/0d8e3831c40e0a2686a397a46eb8b7e4_MD5.jpg" />   </p>
<p>When the “.ini”-file had been created and written to, a call to “SetSecurityFile” was performed to set the permissions for the file to READ/WRITE for all users.   </p>
<p>By sending a custom payload which performed directory traversal to directories(and perform the trick described in the first part of the write-up) and write “.ini” to Alternative Data Streams, the “SSUServer.exe” program was forced into writing data to the directory’s ADS and set the permissions for the directory to READ/WRITE for all users. Afterwards a malicious DLL-file like the above “SRUpdateENU.dll” could be placed in the now writable directory and executed as “NT Authority/System”.   </p>
<p>Payload data sent from exploit to named pipe. <br />
<img alt="" src="/Blogpost/vulnerabilities/Attachments/8558800c57fc620194b36a5e9d5ebf76_MD5.png" />   </p>
<p>Permissions on “C:\Program Files (x86)\Splashtop\Splashtop Remote\Server” was set to READ/WRITE for everyone. Thereby giving the possibility to perform privileged escalation with DLL-hijacking. <br />
<img alt="" src="/Blogpost/vulnerabilities/Attachments/fe3fe44aa822268c64636ee381378f18_MD5.png" />   </p>
<p>Proof-of-concept exploits to perform privileged escalation. “main.dll” copied to “SRUpdateENU.dll” executes a reverse shell. <br />
<img alt="" src="/Blogpost/vulnerabilities/Attachments/40b7c82430805c315190ef146d8bdc16_MD5.png" />   </p>
<p>Splashtop Streamer version 3.3.8.0 comes bundled with Splashtop Updater that fixes this vulnerability.</p></div>
<div class="note-footer">
<div class="tags">

</div>

</div>

                                <!-- end content -->
                                </div>
                        </div>
                </div>
        </div>

        <script src="/obs.html/static/obsidian_tabs_footer.js" type="text/javascript"></script>

        

</body>
</html>
