<!DOCTYPE html>

<html lang="en">

        <head>
                <!-- Page information -->
                <meta charset="UTF-8" />
                <meta name="node_id" content="cve-2020-8342">
                <meta name="viewport" content="width=device-width, initial-scale=1.0" />
                <link rel="shortcut icon" href="/favicon.ico" />

                <!-- Set title -->
                <title>resec.dk</title>

                <!-- Includes -->
                <script src="/obs.html/static/obsidian_core.js"></script>
<script src="/obs.html/static/encoding.js"></script>
<link rel="stylesheet" href="/obs.html/static/master.css" />
<script src="https://unpkg.com/smiles-drawer@2.0.3/dist/smiles-drawer.min.js"></script><script src="/obs.html/static/smiles.js"></script>
<script type="module">
    import mermaid from 'https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.esm.min.mjs';
    mermaid.initialize({
            'securityLevel': 'loose',
            'theme': 'dark',
            'themeVariables': {
                    'darkMode': true,
            }
    });
</script>
<script>
  MathJax = {
    loader: {
      load: [
        '[tex]/action',
        'output/chtml',
        '[tex]/centernot'
      ]
    },
    tex: {
      inlineMath: [ ["\\(","\\)"] ],
      displayMath: [ ["\\[","\\]"] ],
      processEscapes: true,
      processEnvironments: true,
      packages: {'[+]': ['centernot']}
    }
  };
</script>
<script type="text/javascript" id="MathJax-script" async
  src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js">
</script>
<script src="/obs.html/static/dirtree.js"></script>
<link rel="stylesheet" href="/custom.css" />



                <!-- Onload tweaks -->
                <script>
                        const CURRENT_NODE = 'cve-2020-8342';
                        const PAGE_DEPTH = 2;
                </script>
        </head>

<body class="theme-obs-light">
        <div id="antiflash" style="display: none;"></div>
        <script>
                document.getElementById('antiflash').style.display = 'block';
        </script>
        
        <div id="page_holder" class="flex_col">
                <div id="header" class="header" style="position:fixed">
                        <div id="header_flex" class="flex_row">
                                <a href="/index.html" id="homelink" title="Clear screen and go to homepage">resec.dk</a>
                                <div class="navbar-button" onclick="toggle_menu()">
                                        ≡
                                </div>
                                <div id="navbar" class="navbar">
                                        
                                        <a href="/">resec.dk</a>
                                        <div class="icon-tray">
                                                
                                                
                                                
                                        
                                                
                                                
                                        </div>
                                </div>
                        </div>
                        
                </div>
                <div id="header2" class="header">
                        <div id="header_flex2" class="flex_row">
                                <a href="/index.html" id="homelink" title="Clear screen and go to homepage">/resec.dk</a>
                                <div class="navbar-button" onclick="toggle_menu()">
                                        ≡
                                </div>
                                <div id="navbar2" class="navbar">
                                        
                                        <div class="icon-tray">
                                                
                                                
                                                
                                                        <div >
            <a id="dirtree_link" class="system-link" href="/obs.html/dir_index.html" title="View directory tree">
                    <img src = "/obs.html/static/dirtree.svg" style="width: 12px; padding: 4px;" alt="Directory tree link"/>
            </a>
        </div>
                                                
                                                
                                        </div>
                                </div>
                        </div>
                        
                </div>
                <div class="flex_row" id="container_row">
                        <div class="container-wrapper ">
                                <div class="container">
                                <div class="content"><h1 id="lenovo-system-update-privilege-escalation">Lenovo System Update - Privilege Escalation</h1>
<p>Also published here: <a href="https://blog.improsec.com/tech-blog/privilege-escalation-vulnerability-in-lenovo-system-update" class="external-link">Privilege escalation vulnerability in Lenovo System Update — Improsec | improving security</a>   </p>
<p>System Update is an application for keeping drivers, firmwares and software packages up-to-date on Lenovo workstations or laptops. The application often comes preloaded on Lenovo systems.   </p>
<p>Like in my previously disclosed vulnerabilities for Intel Driver &amp; Support Assistant and Splashtop Streamer, the process of updating software and firmware can, if not implemented securely, leave a system vulnerable for privilege escalation.   </p>
<h2 id="cve-registered">CVE registered</h2>
<ul>
<li>CVE-2020-8342   </li>
</ul>
<h2 id="affected-version">Affected version</h2>
<p>System Update 5.07.0097(latest version 04/07/2020)   </p>
<h2 id="timeline">Timeline</h2>
<ul>
<li>04/07/2020 – Lenovo Product Security Incident Response Team e-mailed with detailed description.   </li>
<li>07/07/2020 - Lenovo Product Security Incident Response Team informs that they are investigating the issue.   </li>
<li>10/07/2020 - Lenovo Product Security Incident Response Team confirms the vulnerability, given internal vulnerability number LEN-41150.   </li>
<li>20/08/2020 - Lenovo Product Security Incident Response Team releases version 5.07.0106 of System Update which patches the vulnerability. Lenovo will disclose the vulnerability publicly September 8 2020.   </li>
</ul>
<h2 id="walkthrough">Walkthrough</h2>
<p>The System Update applications run as a low privilege executable(user interface) and a service executable running as “NT Authority/SYSTEM”. Multiple high privilege executables will be spawned by the service executable upon update. Some of these executables are native for Windows and performs temporary permission changes which allow all users to read/write to the two directories: “C:\ProgramData\Lenovo\SystemUpdate\logs” and “C:\ProgramData\Lenovo\SystemUpdate\sessionSE”. These permissions only exists for few seconds before they are reverted again. <br />
<img alt="" src="/Blogpost/vulnerabilities/Attachments/a%206.png" />   </p>
<p>During an update the “SUService.exe” service executable spawns “uncsetting.exe” in the user context of “NT Authority/SYSTEM”. This application checks if the directory “swwork” exists at “C:\swwork”. This directory does not exist by default. <br />
<img alt="" src="/Blogpost/vulnerabilities/Attachments/a%205.png" />   </p>
<p>Reverse engineering the application in Ghidra shows that the “directory check” will execute a new function “FUN_00401f00”(Ghidra autogenerated name) if the directory exists. <br />
<img alt="" src="/Blogpost/vulnerabilities/Attachments/a%204.png" />   </p>
<p>The function “FUN_00401f00” executes the Lenovo application “ConfigScheduledTask.exe” with the argument “createlogintask”. <br />
<img alt="" src="/Blogpost/vulnerabilities/Attachments/a%203.png" />   </p>
<p>Reverse engineering the application “ConfigScheduledTask.exe” showed that it accepted a range of different arguments. The argument “createlogintask” would call the function “CreateLoginOnlyScheduleTask”. <br />
<img alt="" src="/Blogpost/vulnerabilities/Attachments/a.png" />   </p>
<p>Looking at “CreateLoginOnlyScheduleTask” showed, that it would first call the function “UpdateLoginXml”. This function would copy(and overwrite if it existed) “C:\Program Files (x86)\Lenovo\System Update\TVSUUpdateTask_Login.xml” to “C:\ProgramData\Lenovo\SystemUpdate\sessionSE\TVSUUpdateTask_Login.xml”. <br />
<img alt="" src="/Blogpost/vulnerabilities/Attachments/image-asset.png" />   </p>
<p>After performing the file copy, the application executes the native Windows schedule application “schtasks.exe” with arguments that would create a new schedule task from the schedule task XML-file “TVSUUpdateTask_Login.xml” from “C:\ProgramData\Lenovo\SystemUpdate\sessionSE”(at this time read-only file permissions). <br />
<img alt="" src="/Blogpost/vulnerabilities/Attachments/a%202.png" />   </p>
<p><img alt="" src="/Blogpost/vulnerabilities/Attachments/a%201.png" />   </p>
<p>This application logic provided us with a path to perform privilege escalation using the following steps: <br />
1. Create the directory “swwork” in “C:\” <br />
2. Execute System Update <br />
3. System Update shortly performs permission changes to “C:\ProgramData\Lenovo\SystemUpdate\sessionSE” allowing all users to READ/WRITE to the directory and all subdirectories and files. <br />
4. During this brief permission change, we overwrite “TVSUUpdateTask_Login.xml” with a malicious schedule task XML. <br />
5. After overwriting the file, a file handle to “TVSUUpdateTask_Login.xml” is called, allowing other processes to only read the file. This successfully denies “ConfigScheduledTask.exe” the ability to copy and overwrite the real XML file to “C:\ProgramData\Lenovo\SystemUpdate\sessionSE”. <br />
6. Copy/overwrite fails, but “ConfigScheduledTask.exe” continues and loads the malicious schedule task XML-file. <br />
7. The malicious schedule task executes our payload as “NT Authority/SYSTEM” giving us a successfully escalation of privilege.   </p>
<h2 id="proof-of-concept">Proof-of-concept</h2>
<p>A proof-of-concept application below automates the different steps and forces System Update to load “payload.xml” into scheduled tasks.   </p>
<div class="codehilite"><pre><span></span><code><span class="k">using</span><span class="w"> </span><span class="nn">System</span><span class="p">;</span><span class="w">   </span>
<span class="k">using</span><span class="w"> </span><span class="nn">System.IO</span><span class="p">;</span><span class="w">   </span>

<span class="k">namespace</span><span class="w"> </span><span class="nn">lenovo.privesc</span><span class="w">   </span>
<span class="p">{</span><span class="w">   </span>
<span class="w">    </span><span class="k">class</span><span class="w"> </span><span class="nc">Program</span><span class="w">   </span>
<span class="w">    </span><span class="p">{</span><span class="w">   </span>
<span class="w">        </span><span class="n">Console</span><span class="p">.</span><span class="n">WriteLine</span><span class="p">(</span><span class="s">&quot;[+] Creating schedule trigger directory&quot;</span><span class="p">);</span><span class="w">   </span>
<span class="w">        </span><span class="n">Directory</span><span class="p">.</span><span class="n">CreateDirectory</span><span class="p">(</span><span class="s">&quot;C:\\swwork&quot;</span><span class="p">);</span><span class="w">   </span>
<span class="w">        </span><span class="n">Console</span><span class="p">.</span><span class="n">WriteLine</span><span class="p">(</span><span class="s">&quot;[+] Waiting for permission change...&quot;</span><span class="p">);</span><span class="w">   </span>
<span class="w">        </span><span class="k">while</span><span class="p">(</span><span class="k">true</span><span class="p">)</span><span class="w">   </span>
<span class="w">        </span><span class="p">{</span><span class="w">   </span>
<span class="w">            </span><span class="k">try</span><span class="w">   </span>
<span class="w">            </span><span class="p">{</span><span class="w">   </span>
<span class="w">                </span><span class="n">File</span><span class="p">.</span><span class="n">Copy</span><span class="p">(</span><span class="s">&quot;payload.xml&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;C:\\PRogramData\\Lenovo\\SystemUpdate\\sessionSE\\TVSUUpdateTask_Login.xml&quot;</span><span class="p">,</span><span class="w"> </span><span class="k">true</span><span class="p">);</span><span class="w">   </span>
<span class="w">                </span><span class="n">Console</span><span class="p">.</span><span class="n">WriteLine</span><span class="p">(</span><span class="s">&quot;[+] Payload copied&quot;</span><span class="p">);</span><span class="w">   </span>
<span class="w">                </span><span class="n">Console</span><span class="p">.</span><span class="n">WriteLine</span><span class="p">(</span><span class="s">&quot;[+] Locking file&quot;</span><span class="p">);</span><span class="w">   </span>
<span class="w">                </span><span class="n">File</span><span class="p">.</span><span class="n">Open</span><span class="p">(</span><span class="s">&quot;C:\\PRogramData\\Lenovo\\SystemUpdate\\sessionSE\\TVSUUpdateTask_Logion.xml&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">FileMode</span><span class="p">.</span><span class="n">Open</span><span class="p">,</span><span class="w"> </span><span class="n">FileAccess</span><span class="p">.</span><span class="n">Read</span><span class="p">,</span><span class="w"> </span><span class="n">FileShare</span><span class="p">.</span><span class="n">Read</span><span class="p">);</span><span class="w">   </span>
<span class="w">                </span><span class="n">Console</span><span class="p">.</span><span class="n">WriteLine</span><span class="p">(</span><span class="s">&quot;[+] PWned!&quot;</span><span class="p">);</span><span class="w">   </span>
<span class="w">                </span><span class="n">System</span><span class="p">.</span><span class="n">Environment</span><span class="p">.</span><span class="n">Exit</span><span class="p">(</span><span class="m">1</span><span class="p">);</span><span class="w">    </span>
<span class="w">            </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="n">Exception</span><span class="w"> </span><span class="n">e</span><span class="p">)</span><span class="w">   </span>
<span class="w">            </span><span class="p">{</span><span class="w">   </span>
<span class="w">                </span><span class="p">;</span><span class="w">   </span>
<span class="w">            </span><span class="p">}</span><span class="w">   </span>
<span class="w">        </span><span class="p">}</span><span class="w">   </span>
<span class="w">    </span><span class="p">}</span><span class="w">   </span>
<span class="p">}</span><span class="w">   </span>
</code></pre></div></div>
<div class="note-footer">
<div class="tags">

</div>

</div>

                                <!-- end content -->
                                </div>
                        </div>
                </div>
        </div>

        <script src="/obs.html/static/obsidian_tabs_footer.js" type="text/javascript"></script>

        

</body>
</html>
