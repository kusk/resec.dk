<!DOCTYPE html>

<html lang="en">

        <head>
                <!-- Page information -->
                <meta charset="UTF-8" />
                <meta name="node_id" content="cve-2020-8614">
                <meta name="viewport" content="width=device-width, initial-scale=1.0" />
                <link rel="shortcut icon" href="/favicon.ico" />

                <!-- Set title -->
                <title>resec.dk</title>

                <!-- Includes -->
                <script src="/obs.html/static/obsidian_core.js"></script>
<script src="/obs.html/static/encoding.js"></script>
<link rel="stylesheet" href="/obs.html/static/master.css" />
<script src="https://unpkg.com/smiles-drawer@2.0.3/dist/smiles-drawer.min.js"></script><script src="/obs.html/static/smiles.js"></script>
<script type="module">
    import mermaid from 'https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.esm.min.mjs';
    mermaid.initialize({
            'securityLevel': 'loose',
            'theme': 'dark',
            'themeVariables': {
                    'darkMode': true,
            }
    });
</script>
<script>
  MathJax = {
    loader: {
      load: [
        '[tex]/action',
        'output/chtml',
        '[tex]/centernot'
      ]
    },
    tex: {
      inlineMath: [ ["\\(","\\)"] ],
      displayMath: [ ["\\[","\\]"] ],
      processEscapes: true,
      processEnvironments: true,
      packages: {'[+]': ['centernot']}
    }
  };
</script>
<script type="text/javascript" id="MathJax-script" async
  src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js">
</script>
<script src="/obs.html/static/dirtree.js"></script>
<link rel="stylesheet" href="/custom.css" />



                <!-- Onload tweaks -->
                <script>
                        const CURRENT_NODE = 'cve-2020-8614';
                        const PAGE_DEPTH = 2;
                </script>
        </head>

<body class="theme-obs-light">
        <div id="antiflash" style="display: none;"></div>
        <script>
                document.getElementById('antiflash').style.display = 'block';
        </script>
        
        <div id="page_holder" class="flex_col">
                <div id="header" class="header" style="position:fixed">
                        <div id="header_flex" class="flex_row">
                                <a href="/index.html" id="homelink" title="Clear screen and go to homepage">resec.dk</a>
                                <div class="navbar-button" onclick="toggle_menu()">
                                        ≡
                                </div>
                                <div id="navbar" class="navbar">
                                        
                                        <a href="/">resec.dk</a>
                                        <div class="icon-tray">
                                                
                                                
                                                
                                        
                                                
                                                
                                        </div>
                                </div>
                        </div>
                        
                </div>
                <div id="header2" class="header">
                        <div id="header_flex2" class="flex_row">
                                <a href="/index.html" id="homelink" title="Clear screen and go to homepage">/resec.dk</a>
                                <div class="navbar-button" onclick="toggle_menu()">
                                        ≡
                                </div>
                                <div id="navbar2" class="navbar">
                                        
                                        <div class="icon-tray">
                                                
                                                
                                                
                                                        <div >
            <a id="dirtree_link" class="system-link" href="/obs.html/dir_index.html" title="View directory tree">
                    <img src = "/obs.html/static/dirtree.svg" style="width: 12px; padding: 4px;" alt="Directory tree link"/>
            </a>
        </div>
                                                
                                                
                                        </div>
                                </div>
                        </div>
                        
                </div>
                <div class="flex_row" id="container_row">
                        <div class="container-wrapper ">
                                <div class="container">
                                <div class="content"><h1 id="askey-ap4000w-remote-code-execution-vulnerable-firmware-server">Askey AP4000W - Remote Code Execution &amp; Vulnerable Firmware Server</h1>
<p>Also published here: <a href="https://blog.improsec.com/tech-blog/rce-askey" class="external-link">Remote Code Execution by reverse engineering an Askey Wifi-Extender — Improsec | improving security</a>   </p>
<p>This blog highlights bugs and observations found in the WiFi-extender Askey AP4000W during an Improsec “Nerd Day”. Found bugs are reported to the vendor according to our Responsible Disclosure Policy, but this time in close collaboration with TDC.   </p>
<h2 id="timeline">Timeline</h2>
<ul>
<li>The vulnerability and observations of firmware “AP4100W_TDC_V1.01.003” were disclosed to Askey on 17th of September 2019. No response received.   </li>
<li>The vulnerability and observations were disclosed to TDC on 27th of September 2019, as we knew they had customers running the product. TDC agreed to contact hardware vendor on behalf of Improsec, collaborate on getting it fixed, and getting customers updated.   </li>
<li>During December 2019 TDC tested a new firmware from Askey for these devices.   </li>
<li>Askey closed the insecure FTP-server 17th of December 2019, but we found it to be online again by 2nd of January 2020.   </li>
<li>TDC confirms that a new firmware has successfully been deployed to all available devices on 28th of January 2020.   </li>
<li>Insecure firmware FTP-server confirmed to have been secured on the 3rd of February 2020.   </li>
</ul>
<h3 id="cve-registered">CVE registered</h3>
<ul>
<li>CVE: <a href="https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2020-8614" class="external-link">CVE-2020-8614</a>   </li>
</ul>
<h2 id="path-to-discovery">Path to discovery</h2>
<p>Connecting to and scanning the device with NMAP showed the following open ports. <br />
<img alt="" src="/Blogpost/vulnerabilities/Attachments/image-asset%201.png" />   </p>
<p>When doing an NMAP service scan, the service running on port 54188 crashed and a reboot was required to bring it back up. A telnet daemon was also seen on port 23, however, no valid passwords were found for the typical users(root/admin/busybox) in the documentation.   </p>
<p>Viewing the circuit board showed no visible UART or JTAG interfaces, but reading the model number for each integrated circuit showed that it contained a Winbond 25Q128FV EEPROM 16mb memory chip with SOP8 pinout. <br />
<img alt="" src="/Blogpost/vulnerabilities/Attachments/image-asset%202.png" />   </p>
<p>Remote Code Execution by reverse engineering an Askey Wifi-Extender   </p>
<p>By doing a direct EEPROM reading from the Winbond 25Q128FV using a CH341A USB-programmer with a SOIC SOP8 clamp, it was possible to extract raw data from the read-only memory. <br />
<img alt="" src="/Blogpost/vulnerabilities/Attachments/3.png" />   </p>
<p>A typical Busybox filesystem was extracted from the the raw data dump by doing multiple runs of Binwalk. <br />
<img alt="" src="/Blogpost/vulnerabilities/Attachments/4.png" />   </p>
<h2 id="insecure-firmware-server">Insecure firmware server</h2>
<p>In the ”/web” directory the web-based administration interface was located in the binary file “status.cgi”. Looking at the decompiled functions in Ghidra showed, that the application used ”wget” to fetch a new firmware from a FTP-server hosted by Askey. The credentials “Askeyfota” with the password “d400fota” were used. The new firmware would be saved to “/tmp/” which according to the ”/etc/fstab” file, would be RAM-mounted as R/W during boot. <br />
<img alt="" src="/Blogpost/vulnerabilities/Attachments/Picture5.png" />   </p>
<p>Unfortunately, our analysis also showed, that the provided FTP-credentials <strong>had Read and Write rights to most directories on the manufactures FTP-server.</strong> This would allow an attacker to add, delete or modify firmware images for multiple different devices, amongst others, the Askey AP4000W (TDC branded). An attacker could i.e. implant a backdoor into the firmware, as there was no firmware signature validation in the update mechanism.   </p>
<h2 id="the-mysterious-bd_svr-service">The mysterious ”bd_svr” service</h2>
<p>Looking for the unknown service running on port 54188 the start-up script rcS at ”/etc_ro/” was enumerated. In it, an application called “bd_svr” was found. <br />
<img alt="" src="/Blogpost/vulnerabilities/Attachments/Picture6.png" />   </p>
<p>Decompiling the “bd_svr” application in Ghidra showed that the main function called ”tcp_svr_create_socket” with the parameter 0xd3ac which was 54188 as a decimal value. This parameter was used to define the receiving TCP socket port 54188. <br />
<img alt="" src="/Blogpost/vulnerabilities/Attachments/Picture7.png" />   </p>
<p>After creating the socket, the program enters the ”tcp_svr_select_n_handle” function which runs a ”while” loop waiting for client connections. <br />
<img alt="" src="/Blogpost/vulnerabilities/Attachments/dba1aa70dc09519909c2f765cd608068_MD5.png" />   </p>
<p>A quick look through the different functions in the program showed, that it possibly worked as a “backdoor” (bd_svr?) into the device. Functions with names like ”cmd_read”, “cmd_send”, “cmd_write” and ”send_file” indicated this. The program had the calls to system functions like ”lseek”, ”write”, ”lstat”, ”open”, “opendir” and “readdir” which were all functions to interact with the filesystem.   </p>
<h2 id="writing-to-the-remote-file-system">Writing to the remote file system</h2>
<p>Looking at the ”cmd_n_data_send”, ”cmd_write”, ”cmd_send” and ”cmd_read” functions showed, that by sending a crafted message containing a “magic-signature” allowed any unauthenticated user to write files to the filesystem. <br />
<img alt="" src="/Blogpost/vulnerabilities/Attachments/9c07a8cd50f195f330a60984bc702813_MD5.png" />   </p>
<p>The crafted message required the following data fields and structure in order to be valid. <br />
<img alt="" src="/Blogpost/vulnerabilities/Attachments/6d46cef844b107d6f05eaecf27dd1fd6_MD5.png" />   </p>
<p>The following python script reads a user-defined local file and writes it to a path on the remote device. Note that most of the filesystem is read-only. Existing files in R/W mounted directories will be overwritten. <br />
<img alt="" src="/Blogpost/vulnerabilities/Attachments/cc2fbda4593715455b4c97015b904f0a_MD5.png" />   </p>
<p>Below example overwrites ”/etc/passwd” with a version where both users have the DES-encrypted password set to “improsec”. <br />
<img alt="" src="/Blogpost/vulnerabilities/Attachments/1189f12148fc860e68e0412dc9f98ba6_MD5.png" />   </p>
<p>With a known username and password, connecting via telnet was now possible.   </p>
<h2 id="remote-code-executing-without-telnet"><strong>Remote code executing without telnet</strong></h2>
<p>Looking through binaries in the extracted filesystem showed an application called “cmd_agent”. <br />
<img alt="" src="/Blogpost/vulnerabilities/Attachments/4ebf46962ae88d7a7930c40d6bc0e333_MD5.png" />   </p>
<p>Reversing the application showed that it simply created an empty FIFO-file called ”cmd_agent” in ”/tmp/”. The file was constantly read for content, which was executed as console commands. <br />
<img alt="" src="/Blogpost/vulnerabilities/Attachments/3089d60d59bd1f1057e9c3a4070f5a72_MD5.png" />   </p>
<p>Rewriting our above script to ease the execution of commands on the device. <br />
<img alt="" src="/Blogpost/vulnerabilities/Attachments/1ae81b7e48082bc42e32a970d46fbcd0_MD5.png" />   </p>
<p>We already know that wget exists on the device. So using wget to send the first line of ”/etc/passwd” as a path will confirm that we have remote code execution. <br />
<img alt="" src="/Blogpost/vulnerabilities/Attachments/11393308cdae5d12ec9ffefb12270205_MD5.png" />   </p>
<p>The first line of ”/etc/passwd” containing the DES encrypted password for the root user.   </p>
<h2 id="other-research">Other research</h2>
<p>Following the reverse engineering of the device, CVE-2014-0659 came to my attention. The backdoor described by elvanderb shares a lot of the same concepts as the one found in the Askey device. However, the “magic” signature, command type, functionalities, and service name differs.</p></div>
<div class="note-footer">
<div class="tags">

</div>

</div>

                                <!-- end content -->
                                </div>
                        </div>
                </div>
        </div>

        <script src="/obs.html/static/obsidian_tabs_footer.js" type="text/javascript"></script>

        

</body>
</html>
